#![allow(dead_code)]

use std::collections::{BTreeMap, BTreeSet};
use std::fmt;

const PREAMBLE: &'static str = "// WARNING: Auto-generated by unic-gen. DO NOT EDIT MANUALLY!";

pub trait CharMap<T>
where
    T: fmt::Display + Eq,
{
    fn to_bsearch_table(&self) -> String;
}

impl<T> CharMap<T> for BTreeMap<char, T>
where
    T: fmt::Display + Eq,
{
    fn to_bsearch_table(&self) -> String {
        let mut entries = self.iter();

        let first = entries.next();
        if first.is_none() {
            return String::from("&[]");
        }

        let (mut low, mut value) = first.unwrap();
        let mut high = low;
        let mut out = String::from("&[\n");

        for (char, property) in entries {
            if property != value || (*char as u32) > (*high as u32 + 1) {
                append_triple(&mut out, *low, *high, value);
                low = char;
                high = char;
                value = property;
            } else {
                assert!((*char as u32) == (*high as u32 + 1));
                high = char;
            }
        }

        append_triple(&mut out, *low, *high, value);
        out.push_str("]");
        out
    }
}

impl CharMap<()> for BTreeSet<char> {
    fn to_bsearch_table(&self) -> String {
        let mut entries = self.iter();

        let first = entries.next();
        if first.is_none() {
            return String::from("&[]");
        }

        let mut low = first.unwrap();
        let mut high = low;
        let mut out = String::from("&[\n");

        for char in entries {
            if (*char as u32) > (*high as u32 + 1) {
                append_duple(&mut out, *low, *high);
                low = char;
                high = char;
            } else {
                assert!((*char as u32) == (*high as u32 + 1));
                high = char;
            }
        }

        append_duple(&mut out, *low, *high);
        out.push_str("]");
        out
    }
}

fn append_triple<T>(str: &mut String, a: char, b: char, c: T)
where
    T: fmt::Display,
{
    str.push_str(
        &format!(
            "    ('{}', '{}', {}),\n",
            a.escape_unicode(),
            b.escape_unicode(),
            c,
        )
    )
}

fn append_duple(str: &mut String, a: char, b: char) {
    str.push_str(
        &format!(
            "    ('{}', '{}'),\n",
            a.escape_unicode(),
            b.escape_unicode(),
        )
    )
}

#[cfg(test)]
mod test {
    use super::*;

    #[test]
    fn simple_map_bsearch_table() {
        let mut map: BTreeMap<char, &'static str> = Default::default();
        map.insert('a', "Low");
        map.insert('b', "Low");
        map.insert('c', "Low");
        map.insert('d', "Mid");
        map.insert('y', "High");
        map.insert('f', "Mid");
        map.insert('e', "Mid");
        map.insert('x', "High");
        map.insert('z', "High");
        assert_eq!(
            map.to_bsearch_table(),
            "\
&[
    ('\\u{61}', '\\u{63}', Low),
    ('\\u{64}', '\\u{66}', Mid),
    ('\\u{78}', '\\u{7a}', High),
]"
        );
    }

    #[test]
    fn simple_set_bsearch_table() {
        let mut set: BTreeSet<char> = Default::default();
        set.insert('a');
        set.insert('b');
        set.insert('c');
        set.insert('d');
        set.insert('y');
        set.insert('f');
        set.insert('e');
        set.insert('x');
        set.insert('z');
        assert_eq!(
            set.to_bsearch_table(),
            "\
&[
    ('\\u{61}', '\\u{66}'),
    ('\\u{78}', '\\u{7a}'),
]"
        )
    }
}
